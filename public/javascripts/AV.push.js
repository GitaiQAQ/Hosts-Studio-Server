void function(e){var t="2.0.4";var n=e.AV||{};e.AV=n;if(typeof define==="function"&&define.amd){define("AV",[],function(){return n})}var o={heartbeatsTime:30*1e3};var i={};var r={};var a={open:"open",close:"close",message:"message",reuse:"reuse",error:"error"};var s=function(){var t={options:undefined,ws:undefined,heartbeatsTimer:undefined,ec:undefined,closeFlag:false,reuseTimer:undefined};var n=function(){i.log("WebSocket opened.");r.loginPush(t.options);r.heartbeats();r.guard();t.ec.emit(a.open)};var s=function(){i.log("WebSocket closed.");t.ec.emit(a.close)};var c=function(e){var n=JSON.parse(e.data);if(n.cmd==="data"){r.ackPush(n.ids);var o;var i=n.msg.length;for(o=0;o<i;o++){t.ec.emit(a.message,n.msg[o])}}};var u=function(e){throw e};var p=function(e){t.ws.send(JSON.stringify(e))};var f=function(e,t,n){var o=[];if(typeof e==="string"){o.push(e)}else{o=e}r.channels(o,t,n)};r.getId=function(e){var t="AV/"+e.appId+"/installationId";var n=i.storage(t);if(n){return n}else{id=i.getId();e.id=id;r.sendId(e,function(e){i.storage(t,id)});return id}};r.sendId=function(e,n){i.ajax({url:"https://"+t.options.host+"/1.1/installations",method:"post",appId:e.appId,appKey:e.appKey,data:{deviceType:e.deviceType,installationId:e.id,channels:e.channels}},function(o){if(o){if(n){n(o);t.ec.emit("leancloud-send-id-ok")}}else{setTimeout(function(){r.sendId(e)},5e3)}})};r.sendPush=function(e,n){i.ajax({url:"https://"+t.options.host+"/1.1/push",method:"post",appId:e.appId,appKey:e.appKey,data:{data:e.data,channels:e.channels}},function(t,o){if(t){if(n){n(t)}}else{if(o.code===403||o.code===404){throw o.error}else{setTimeout(function(){r.sendPush(e,n)},5e3)}}})};r.channels=function(e,n,o){var r={installationId:t.options.id,deviceType:t.options.deviceType};if(o){r.channels={__op:"Remove",objects:e}}else{r.channels=e}i.ajax({url:"https://"+t.options.host+"/1.1/installations",method:"post",appId:t.options.appId,appKey:t.options.appKey,data:r},function(e){if(n){n(e)}})};r.createSocket=function(e){var o=new WebSocket(e);t.ws=o;o.addEventListener("open",n);o.addEventListener("close",s);o.addEventListener("message",c);o.addEventListener("error",u)};r.heartbeats=function(){p({});t.ws.addEventListener("message",function(){if(t.heartbeatsTimer){clearTimeout(t.heartbeatsTimer)}t.heartbeatsTimer=setTimeout(function(){p({})},o.heartbeatsTime)})};r.guard=function(){t.ec.on(a.close,function(){if(!t.closeFlag){t.ec.emit(a.reuse)}})};r.connect=function(e){var n=e.server;if(n&&i.now()<n.expires){r.createSocket(n.server)}else{t.ec.emit(a.error);throw"WebSocket connet failed."}};r.ackPush=function(e){p({cmd:"ack",appId:t.options.appId,installationId:t.options.id,ids:e})};r.loginPush=function(e){p({cmd:"login",appId:e.appId,installationId:e.id})};r.getServer=function(n,o){var r=n.appId;var s=n.secure;var c="";var u="http://";if(e&&e.location.protocol==="https:"){u="https://"}var p="";switch(n.region){case"cn":p="g0";break;case"us":p="a0";break;default:throw"There is no this region."}c=u+"router-"+p+"-push.leancloud.cn/v1/route?appId="+r;if(s){c+="&secure=1"}i.ajax({url:c},function(e,n){if(e){e.expires=i.now()+e.ttl*1e3;t.server=e;o(e)}else{if(n.code===403||n.code===404){throw n.error}else{t.ec.emit(a.error)}}})};return{installationId:"",cache:t,open:function(e){var n=this;r.getServer(t.options,function(e){if(e){r.connect({server:t.server})}});if(e){t.ec.on(a.open,e)}t.ec.once(a.reuse+" "+a.error,function(){if(t.reuseTimer){clearTimeout(t.reuseTimer)}t.reuseTimer=setTimeout(function(){n.open()},5e3)});return this},close:function(){t.closeFlag=true;t.ws.close();return this},on:function(e,n){t.ec.on(e,n);return this},once:function(e,n){t.ec.once(e,n);return this},off:function(e,n){t.ec.off(e,n);return this},emit:function(e,n){t.ec.emit(e,n);return this},send:function(e,n){var o={appId:t.options.appId,appKey:t.options.appKey};if(!e.channels&&!e.where&&!e.expiration_time&&!e.expiration_interval&&!e.push_time){o.data=e;r.sendPush(o,n)}else{for(var i in e){o[i]=e[i]}r.sendPush(o,n)}return this},subscribe:function(e,t){f(e,t);return this},unsubscribe:function(e,t){f(e,t,true);return this},receive:function(e){if(!e){throw"Receive must hava callback."}t.ec.on(a.message,function(t){e(t)});return this}}};n.push=function(t){if(typeof t!=="object"){throw"AV.push need a argument at least."}else if(!t.appId){throw"Options must have appId."}else if(!t.appKey){throw"Options must have appKey."}else{var n=e.WebSocket.loadFlashPolicyFile?false:true;t={appId:t.appId,appKey:t.appKey,peerId:t.clientId,secure:typeof t.secure==="undefined"?n:t.secure,region:t.region||"cn",channels:t.channels||[],deviceType:"web"};switch(t.region){case"cn":t.host="leancloud.cn";break;case"us":t.host="avoscloud.us";break}var o=s();o.cache.options=t;t.id=r.getId(t);o.installationId=t.id;o.cache.ec=i.eventCenter();return o}};n.push.version=t;n.push._tool=i;n.push._engine=r;i.noop=function(){};i.getId=function(){var e=function(){return Date.now().toString(36)+Math.random().toString(36).substring(2,3)};return"AV-"+e()+"-"+e()+"-"+e()};i.log=function(e){console.log(e)};i.ajax=function(e,t){var n=e.url;var o=e.method||"get";var i=new XMLHttpRequest;i.open(o,n);if(o==="post"||o==="put"){i.setRequestHeader("Content-Type","application/json")}if(e.appId){i.setRequestHeader("X-AVOSCloud-Application-Id",e.appId)}if(e.appKey){i.setRequestHeader("X-AVOSCloud-Application-Key",e.appKey)}i.onprogress=function(){};i.ontimeout=function(){};i.timeout=0;i.onload=function(e){if(i.status>=200&&i.status<300){t(JSON.parse(i.responseText))}else{t(null,JSON.parse(i.responseText))}};i.onerror=function(e){t(null,e);throw"Network error."};i.send(JSON.stringify(e.data))};i.now=function(){return Date.now()};i.storage=function(t,n){if(n){if(typeof n==="object"){n=JSON.stringify(n)}e.localStorage.setItem(t,n)}else{var o=e.localStorage.getItem(t);if(/^[\{|\[]/.test(o)&&/[\}|\]]$/.test(o)){o=JSON.parse(o)}return o}};i.eventCenter=function(){var e={};var t={};var n=function(n,o,i){if(!n){throw"No event name."}else if(!o){throw"No callback function."}var r=n.split(/\s+/);var a;if(!i){a=e}else{a=t}for(var s=0,c=r.length;s<c;s++){if(r[s]){if(!a[r[s]]){a[r[s]]=[]}a[r[s]].push(o)}}};var o=function(n,o,i){var r;if(!i){r=e}else{r=t}if(r[n]){var a=0;var s=r[n].length;for(;a<s;a++){if(r[n][a]===o){r[n][a]=null;return}}}};function i(e){var t=[];var n=0;var o=e.length;if(o){for(;n<o;n++){if(e[n]){t.push(e[n])}}return t}else{return null}}return{on:function(e,t){n(e,t);return this},once:function(e,t){n(e,t,true);return this},emit:function(n,r){if(!n){throw"No emit event name."}var a=0;var s=0;if(e[n]){a=0;s=e[n].length;for(;a<s;a++){if(e[n][a]){e[n][a].call(this,r)}}e[n]=i(e[n])}if(t[n]){a=0;s=t[n].length;for(;a<s;a++){if(t[n][a]){t[n][a].call(this,r);o(n,t[n][a],true)}}t[n]=i(t[n])}return this},off:function(e,t){o(e,t);return this}}}}(window);